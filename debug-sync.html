<!DOCTYPE html>
<html>
<head>
  <title>TimeFlow Sync Debug</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
    .section { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    pre { background: #f0f0f0; padding: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h1>TimeFlow Sync Debug Tool</h1>
  
  <div class="section">
    <h2>1. Check Sync State</h2>
    <button onclick="checkSyncState()">Check Local Sync Cursor</button>
    <pre id="syncState"></pre>
  </div>

  <div class="section">
    <h2>2. Check Local Data</h2>
    <button onclick="checkLocalData()">Count Local Entities</button>
    <pre id="localData"></pre>
  </div>

  <div class="section">
    <h2>3. Reset Sync Cursor</h2>
    <button onclick="resetCursor()">Reset Cursor (Force Full Pull)</button>
    <pre id="resetResult"></pre>
  </div>

  <div class="section">
    <h2>4. Manual Sync Test</h2>
    <button onclick="testPull()">Test Pull (with logs)</button>
    <pre id="pullResult"></pre>
  </div>

  <script type="module">
    // Import Dexie
    import Dexie from 'https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.mjs';

    // Open TimeFlow database
    const db = new Dexie('TimeFlowDB');
    db.version(4).stores({
      timeslots: 'id, start, end, updatedAt, userId, deletedAt',
      tags: 'id, domainId, name, userId, deletedAt',
      domains: 'id, name, order, userId, deletedAt',
      dailyLogs: 'id, date, userId, deletedAt',
      outbox: 'id, status, entity, entityId, createdAt',
      syncState: 'id, userId',
      conflicts: 'id, entity, entityId, conflictedAt',
    });

    window.checkSyncState = async function() {
      const syncState = await db.syncState.get('sync_cursor');
      document.getElementById('syncState').textContent = JSON.stringify(syncState, null, 2);
    };

    window.checkLocalData = async function() {
      const timeslots = await db.timeslots.toArray();
      const tags = await db.tags.toArray();
      const domains = await db.domains.toArray();
      const outbox = await db.outbox.toArray();
      
      const result = {
        timeslots: {
          total: timeslots.length,
          active: timeslots.filter(s => !s.deletedAt).length,
        },
        tags: {
          total: tags.length,
          active: tags.filter(t => !t.deletedAt).length,
        },
        domains: {
          total: domains.length,
          active: domains.filter(d => !d.deletedAt).length,
        },
        outbox: {
          total: outbox.length,
          pending: outbox.filter(o => o.status === 'pending').length,
          failed: outbox.filter(o => o.status === 'failed').length,
          synced: outbox.filter(o => o.status === 'synced').length,
        }
      };
      
      document.getElementById('localData').textContent = JSON.stringify(result, null, 2);
    };

    window.resetCursor = async function() {
      await db.syncState.delete('sync_cursor');
      document.getElementById('resetResult').textContent = 'Sync cursor deleted. Next sync will pull all data.';
    };

    window.testPull = async function() {
      const output = document.getElementById('pullResult');
      output.textContent = 'Testing pull...\n\n';
      
      try {
        const syncState = await db.syncState.get('sync_cursor');
        output.textContent += `Current cursor: ${syncState?.lastPullCursor || 'none'}\n\n`;
        
        // This will be called from the app's sync function
        output.textContent += 'Please check browser console for detailed sync logs.\n';
        output.textContent += 'Open DevTools â†’ Console and run: await window.__debugSync()\n';
      } catch (error) {
        output.textContent += `Error: ${error.message}`;
      }
    };
  </script>
</body>
</html>

